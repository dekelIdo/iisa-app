<div class="registration-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Join the Israeli Imaginary Space Agency</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <!-- Form Selection Interface -->
      <div class="form-selection" *ngIf="showFormSelection">
        <div class="selection-header">
          <h3>Choose Your Path</h3>
          <p>Select how you'd like to proceed with your application</p>
        </div>
        
        <div class="selection-options">
          <div class="selection-option" (click)="selectFormType('edit')">
            <div class="option-icon">
              <mat-icon>edit</mat-icon>
            </div>
            <div class="option-content">
              <h4>Already Registered</h4>
              <p>Update your existing application details</p>
            </div>
            <mat-icon class="arrow-icon">arrow_forward</mat-icon>
          </div>
          
          <div class="selection-option" (click)="selectFormType('new')">
            <div class="option-icon">
              <mat-icon>person_add</mat-icon>
            </div>
            <div class="option-content">
              <h4>New Registration</h4>
              <p>Submit a new application for the space mission</p>
            </div>
            <mat-icon class="arrow-icon">arrow_forward</mat-icon>
          </div>
        </div>
      </div>

      <!-- Email Check Section (Only for Edit) -->
      <div class="email-check-section" *ngIf="!showFormSelection && selectedFormType === 'edit' && !emailChecked">
        <div class="section-header">
          <button mat-icon-button type="button" class="back-button" (click)="goBackToSelection($event)">
            <mat-icon>arrow_back</mat-icon>
          </button>
          <div class="email-check-header">
            <h3>Already registered?</h3>
            <p>Enter your email to update your details</p>
          </div>
        </div>
        
        <form [formGroup]="emailCheckForm" (ngSubmit)="checkEmailForExisting()" class="email-check-form">
          <div class="email-check-input">
            <mat-form-field appearance="outline">
              <mat-label>Email Address</mat-label>
              <input matInput formControlName="checkEmail" type="email" placeholder="Enter your email address">
              <mat-icon matPrefix>email</mat-icon>
              <button matSuffix mat-icon-button type="button" (click)="emailCheckForm.get('checkEmail')?.setValue('')" *ngIf="emailCheckForm.get('checkEmail')?.value">
                <mat-icon>close</mat-icon>
              </button>
              <mat-error *ngIf="emailCheckForm.get('checkEmail')?.hasError('email')">
                Please enter a valid email address
              </mat-error>
            </mat-form-field>
            
            <button mat-raised-button color="primary" type="submit" [disabled]="emailCheckForm.invalid">
              <mat-icon>search</mat-icon>
              Check
            </button>
          </div>
        </form>
      </div>

      <!-- Email Check Result (Only for Edit) -->
      <div class="email-check-result" *ngIf="!showFormSelection && selectedFormType === 'edit' && emailChecked">
        <div class="section-header">
          <button mat-icon-button type="button" class="back-button" (click)="goBackToSelection($event)">
            <mat-icon>arrow_back</mat-icon>
          </button>
        </div>
        
        <div class="result-message" [class]="emailCheckMessageType">
          <mat-icon *ngIf="emailCheckMessageType === 'success'">check_circle</mat-icon>
          <mat-icon *ngIf="emailCheckMessageType === 'error'">error</mat-icon>
          <span>{{emailCheckMessage}}</span>
        </div>
        
        <button mat-stroked-button type="button" color="primary" (click)="goBackToSelection($event)" *ngIf="emailCheckMessageType === 'error'">
          <mat-icon>arrow_back</mat-icon>
          Go Back to Selection
        </button>
      </div>

      <!-- Registration Form (Only when not showing selection) -->
      <form [formGroup]="registrationForm" (ngSubmit)="onSubmit()" *ngIf="!showFormSelection && (selectedFormType === 'new' || (selectedFormType === 'edit' && isEditing))">
        <div class="section-header">
          <button mat-icon-button type="button" class="back-button" (click)="goBackToSelection($event)">
            <mat-icon>arrow_back</mat-icon>
          </button>
        </div>

        <div class="edit-info" *ngIf="isEditing">
          <mat-icon>edit</mat-icon>
          <span>Editing existing submission ({{daysRemaining}} day(s) remaining)</span>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Full Name</mat-label>
            <input matInput formControlName="fullName" placeholder="Enter your first and last name">
            <button matSuffix mat-icon-button type="button" (click)="clearField('fullName')" *ngIf="registrationForm.get('fullName')?.value">
              <mat-icon>close</mat-icon>
            </button>
            <mat-error *ngIf="registrationForm.get('fullName')?.hasError('required')">
              Full name is required
            </mat-error>
            <mat-error *ngIf="registrationForm.get('fullName')?.hasError('fullNameFormat')">
              Please enter your first name and last name
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Email</mat-label>
            <input matInput formControlName="email" type="email" placeholder="Enter your email" (blur)="checkExistingSubmission()">
            <button matSuffix mat-icon-button type="button" (click)="clearField('email')" *ngIf="registrationForm.get('email')?.value">
              <mat-icon>close</mat-icon>
            </button>
            <mat-error *ngIf="registrationForm.get('email')?.hasError('required')">
              Email is required
            </mat-error>
            <mat-error *ngIf="registrationForm.get('email')?.hasError('email')">
              Please enter a valid email address
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Phone Number</mat-label>
            <input matInput formControlName="phone" placeholder="Enter your phone number" 
                   (input)="onPhoneInput($event)" 
                   (keypress)="onPhoneKeyPress($event)">
            <button matSuffix mat-icon-button type="button" (click)="clearField('phone')" *ngIf="registrationForm.get('phone')?.value">
              <mat-icon>close</mat-icon>
            </button>
            <mat-error *ngIf="registrationForm.get('phone')?.hasError('required')">
              Phone number is required
            </mat-error>
            <mat-error *ngIf="registrationForm.get('phone')?.hasError('pattern')">
              Please enter a valid phone number (numbers only)
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Date of Birth</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="dateOfBirth" placeholder="Choose your date of birth" [max]="maxDate" [min]="minDate">
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <button matSuffix mat-icon-button type="button" (click)="clearField('dateOfBirth')" *ngIf="registrationForm.get('dateOfBirth')?.value">
              <mat-icon>close</mat-icon>
            </button>
            <mat-error *ngIf="registrationForm.get('dateOfBirth')?.hasError('required')">
              Date of birth is required
            </mat-error>
            <mat-error *ngIf="registrationForm.get('dateOfBirth')?.hasError('invalidDate')">
              Please enter a valid date
            </mat-error>
            <mat-error *ngIf="registrationForm.get('dateOfBirth')?.hasError('tooYoung')">
              You must be at least 18 years old
            </mat-error>
            <mat-error *ngIf="registrationForm.get('dateOfBirth')?.hasError('tooOld')">
              Please enter a valid date of birth
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row single-field">
          <mat-form-field appearance="outline">
            <mat-label>City or Region</mat-label>
            <mat-select formControlName="city" placeholder="Select your city">
              <mat-option *ngFor="let city of validCities" [value]="city">{{city}}</mat-option>
            </mat-select>
            <mat-error *ngIf="registrationForm.get('city')?.hasError('required')">
              City is required
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row single-field">
          <mat-form-field appearance="outline">
            <mat-label>Hobbies</mat-label>
            <textarea matInput formControlName="hobbies" placeholder="Tell us about your hobbies" rows="3"></textarea>
            <button matSuffix mat-icon-button type="button" (click)="clearField('hobbies')" *ngIf="registrationForm.get('hobbies')?.value">
              <mat-icon>close</mat-icon>
            </button>
            <mat-error *ngIf="registrationForm.get('hobbies')?.hasError('required')">
              Hobbies are required
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row single-field">
          <mat-form-field appearance="outline">
            <mat-label>Why I am the perfect candidate</mat-label>
            <textarea matInput formControlName="whyPerfect" placeholder="Explain why you're perfect for space mission" rows="4"></textarea>
            <button matSuffix mat-icon-button type="button" (click)="clearField('whyPerfect')" *ngIf="registrationForm.get('whyPerfect')?.value">
              <mat-icon>close</mat-icon>
            </button>
            <mat-error *ngIf="registrationForm.get('whyPerfect')?.hasError('required')">
              This field is required
            </mat-error>
          </mat-form-field>
        </div>

        <div class="image-upload-section">
          <mat-card class="upload-card">
            <mat-card-content>
              <div class="upload-area" [class.has-image]="profileImagePreview">
                <div class="upload-content" *ngIf="!profileImagePreview">
                  <mat-icon class="upload-icon">cloud_upload</mat-icon>
                  <h3>Upload Profile Image</h3>
                  <p>Drag and drop your image here, or click to browse</p>
                  <p class="file-types">Supported formats: JPEG, PNG</p>
                  <button mat-stroked-button color="primary" type="button" (click)="triggerFileInput()">
                    <mat-icon>add_photo_alternate</mat-icon>
                    Choose Image
                  </button>
                </div>
                
                <div class="image-preview" *ngIf="profileImagePreview">
                  <img [src]="profileImagePreview" alt="Profile preview" class="preview-image">
                  <div class="image-actions">
                    <button mat-icon-button color="primary" type="button" (click)="triggerFileInput()" matTooltip="Change image">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" type="button" (click)="removeImage()" matTooltip="Remove image">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>
                
                <input 
                  type="file" 
                  id="profileImage" 
                  accept="image/jpeg,image/png" 
                  (change)="onFileSelected($event)"
                  (click)="$event.stopPropagation()"
                  class="file-input"
                  #fileInput>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <div class="form-actions">
          <button mat-raised-button color="primary" type="submit" [disabled]="registrationForm.invalid">
            {{ existingCandidate ? 'Update Application' : 'Submit Application' }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div> 